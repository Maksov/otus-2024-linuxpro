## Домашее задание № 18 Network

### Занятие 28. Архитектура сетей

#### Цель

Научится менять базовые сетевые настройки в Linux-based системах.

#### Описание домашнего задания

1. Скачать и развернуть Vagrant-стенд https://github.com/erlong15/otus-linux/tree/network
2. Построить следующую сетевую архитектуру:
Сеть office1
- 192.168.2.0/26      - dev
- 192.168.2.64/26     - test servers
- 192.168.2.128/26    - managers
- 192.168.2.192/26    - office hardware

Сеть office2
- 192.168.1.0/25      - dev
- 192.168.1.128/26    - test servers
- 192.168.1.192/26    - office hardware

Сеть central
- 192.168.0.0/28     - directors
- 192.168.0.32/28    - office hardware
- 192.168.0.64/26    - wifi

Итого должны получиться следующие сервера:
inetRouter
centralRouter
office1Router
office2Router
centralServer
office1Server
office2Server

Задание состоит из 2-х частей: теоретической и практической.
В теоретической части требуется: 
Найти свободные подсети
Посчитать количество узлов в каждой подсети, включая свободные
Указать Broadcast-адрес для каждой подсети
Проверить, нет ли ошибок при разбиении

В практической части требуется: 
Соединить офисы в сеть согласно логической схеме и настроить роутинг
Интернет-трафик со всех серверов должен ходить через inetRouter
Все сервера должны видеть друг друга (должен проходить ping)
У всех новых серверов отключить дефолт на NAT (eth0), который vagrant поднимает для связи
Добавить дополнительные сетевые интерфейсы, если потребуется


#### Ход работы

#### Теоретическая часть

В теоретической части нам необходимо продумать топологию сети, а также:
Найти свободные подсети
Посчитать количество узлов в каждой подсети, включая свободные
Указать Broadcast-адрес для каждой подсети
Проверить, нет ли ошибок при разбиении

Первым шагом мы рассмотрим все сети, указанные в задании. Посчитаем для них количество узлов, найдём Broadcast-адрес, проверим, нет ли ошибок при разбиении.

После расчета всех сетей, получаем следующую таблицу топологии

|   Name            | Network          | Netmask         |  N  |   Hostmin     |   Hostmax     |  Broadcast    | 
|-------------------|------------------|-----------------|-----|---------------|---------------|---------------|
|Central Network        
|Directors          | 192.168.0.0/28   | 255.255.255.240 | 14  | 192.168.0.1   | 192.168.0.14  | 192.168.0.15  |
|Office hardware    | 192.168.0.32/28  | 255.255.255.240 | 14  | 192.168.0.33  | 192.168.0.46  | 192.168.0.47  |
|WiFi (mgt network) | 192.168.0.64/26  | 255.255.255.192 | 62  | 192.168.0.65  | 192.168.0.126 | 192.168.0.127 |
|Office 1 Network   
|Dev                | 192.168.2.0/26   | 255.255.255.192 | 62  | 192.168.2.1   | 192.168.2.62  | 192.168.2.63  |
|Test               | 192.168.2.64/26  | 255.255.255.192 | 62  | 192.168.2.65  | 192.168.2.126 | 192.168.2.127 |
|Managers           | 192.168.2.128/26 | 255.255.255.192 | 62  | 192.168.2.129 | 192.168.2.190 | 192.168.2.191 |
|Office hardware    | 192.168.2.192/26 | 255.255.255.192 | 62  | 192.168.2.193 | 192.168.2.254 | 192.168.2.255 |
|Office 2 Network
|Dev                | 192.168.1.0/25   | 255.255.255.128 | 126 | 192.168.1.1   | 192.168.1.126 | 192.168.1.127 |  
|Test               | 192.168.1.128/26 | 255.255.255.192 | 62  | 192.168.1.129 | 192.168.1.190 | 192.168.1.191 |  
|Office             | 192.168.1.192/26 | 255.255.255.192 | 63  | 192.168.1.193 | 192.168.1.254 | 192.168.1.255 | 
|InetRouter — CentralRouter network
|Inet-central       | 192.168.255.0/30 | 255.255.255.252 | 2   | 192.168.255.1 | 192.168.255.2 | 192.168.255.3 |  

После создания таблицы топологии, мы видим, что ошибок в задании нет, также мы сразу видим следующие свободные сети: 

192.168.0.16/28 
192.168.0.48/28
192.168.0.128/25
192.168.255.64/26
192.168.255.32/27
192.168.255.16/28
192.168.255.8/29  
192.168.255.4/30 


#### Практическая часть

![Рисунок](1.png)

На основании этой схемы мы получаем готовый список серверов.
Server

```
+=================+=================+
|     IP-адрес     | IP and Bitmask |
+-----------------+-----------------+
|                  |  Default-NAT address VirtualBox     |
|    inetRouter    |-----------------------------
|                  |   192.168.255.1/30          
|------------------|---------------------------------
|                  |  192.168.255.2/30
|                  |------------------------
|                  |  192.168.0.1/28
|                  |------------------------
|                  |  192.168.0.33/28
|                  |------------------------
|  centralRouter   |  192.168.0.65/26
|                  |------------------------
|                  |  192.168.255.9/30
|                  |------------------------
|                  |  192.168.255.5/30
|------------------|------------------------
|  centralServer   |  192.168.0.2/28   
|------------------|-------------------------
|                  |  192.168.255.10/30
|                  |-------------------------
|                  |  192.168.2.1/26
|                  |-----------------------------
|  office1Router   |  192.168.2.65/26
|                  |-------------------------
|                  |  192.168.2.129/26
|                  |-----------------------------
|                  |  192.168.2.193/26
|------------------|-------------------------
|  office1Server   |  192.168.2.130/26
|------------------|-----------------------------
|                  |  192.168.255.6/30
|                  |--------------------------
|                  |  192.168.1.1/26  
|  office2Router   |-------------------------
|                  |  192.168.1.129/26
|                  |---------------------------
|                  |  192.168.1.193/26
|------------------|---------------------------
|  office2Server   |  192.168.1.2/26
+------------------+-----------------------

```

Скачаем Vagrantfile из репозитория https://github.com/erlong15/otus-linux/tree/network
И приведем в вид согласно методичким рекомендациям.

#### Настройка NAT

Для того, чтобы правила применялись после перезагрузки, в Ubuntu 22.04 нужно выполнить следующие действия:


1)Подключиться по SSH к хосту: vagrant ssh inetRouter
2)Проверить, что отключен другой файервол: systemctl status ufw
root@inetRouter:~# systemctl status ufw
● ufw.service - Uncomplicated firewall
     Loaded: loaded (/lib/systemd/system/ufw.service; enabled; vendor preset: enabled)
     Active: active (exited) since Sat 2023-10-14 15:48:04 UTC; 7min ago
       Docs: man:ufw(8)
   Main PID: 517 (code=exited, status=0/SUCCESS)
        CPU: 3ms

Oct 14 15:48:04 inetRouter systemd[1]: Starting Uncomplicated firewall...
Oct 14 15:48:04 inetRouter systemd[1]: Finished Uncomplicated firewall.
root@inetRouter:~#


Если служба будет запущена, то нужно её отключить и удалить из автозагрузки:
systemctl stop ufw
systemctl disable ufw

3) Создаём файл /etc/iptables_rules.ipv4:
vi /etc/iptables_rules.ipv4

# Generated by iptables-save v1.8.7 on Sat Oct 14 16:14:36 2023
*filter
:INPUT ACCEPT [90:8713]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [54:7429]
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
COMMIT
# Completed on Sat Oct 14 16:14:36 2023
# Generated by iptables-save v1.8.7 on Sat Oct 14 16:14:36 2023
*nat
:PREROUTING ACCEPT [1:44]
:INPUT ACCEPT [1:44]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A POSTROUTING ! -d 192.168.0.0/16 -o eth0 -j MASQUERADE
COMMIT
# Completed on Sat Oct 14 16:14:36 2023


4) Создаём файл, в который добавим скрипт автоматического восстановления правил при перезапуске системы:
vi /etc/network/if-pre-up.d/iptables

#!/bin/sh
/sbin/iptables-restore < /etc/iptables_rules.ipv4

5) Добавляем права на выполнение файла /etc/network/if-pre-up.d/iptables
sudo chmod +x /etc/network/if-pre-up.d/iptables

6) Перезагружаем сервер: reboot
7) После перезагрузки сервера проверяем правила iptables: iptables-save
